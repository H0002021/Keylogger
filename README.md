# 键鼠记录器脚本（[Keylogger](https://github.com/H0002021/Keylogger)）修改说明文档

## 文档说明

本文档记录 `app.py` 脚本从初始版本到最终版本的核心功能迭代与修改细节，涵盖功能新增、参数优化、交互调整等关键变更，便于后续维护与版本追溯。

## 一、核心功能定位

最终版本脚本定位为 **“轻量级键鼠操作记录工具”**，支持记录键盘按键（含组合键）、鼠标左 / 右 / 中间键的按下 / 松开事件，生成结构化日志，并通过命令行参数灵活控制运行模式。

## 二、关键修改历史与说明

### 1. 初始功能搭建（基础记录能力）

#### 1.1 核心功能实现

- **键盘记录**：通过 `pynput.keyboard` 监听键盘按下 / 松开事件，支持记录普通键（如 `a`/`1`）、特殊键（如 `<enter>`/`<backspace>`）及组合键（如 `ctrl+c`/`shift+alt+del`），解决 `Ctrl` 组合键乱码问题（通过控制字符映射表 `control_chars` 映射）。
- **日志配置**：日志文件固定为 `keyboard_log.txt`，按 `时间戳 - 事件内容` 格式记录，编码为 UTF-8，支持自动删除旧日志文件。
- **弹窗交互**：启动时显示 “键盘捕捉已开启（按下 Ctrl+F12 结束）” 弹窗，退出时显示 “键盘记录器已结束” 弹窗（基于 `tkinter.messagebox` 实现）。

#### 1.2 窗口控制

- 初始版本通过 `win32gui` 隐藏控制台窗口，确保后台运行，但存在 “窗口隐藏后进程易退出” 问题（后续优化）。

### 2. 功能迭代与优化（版本 2-5）

#### 2.1 快捷键修改（退出方式优化）

- **需求**：将退出快捷键从 `Ctrl+F12` 改为 `Ctrl+Shift+F12`，减少误触概率。
- **修改点**：在 `_on_key_release` 方法中，将退出条件从 `self.ctrl_pressed and key == keyboard.Key.f12` 调整为 `self.ctrl_pressed and self.shift_pressed and key == keyboard.Key.f12`，同时同步更新启动弹窗的快捷键提示文本。

#### 2.2 鼠标记录功能新增

- **需求**：新增鼠标左 / 右 / 中间键的按下 / 松开记录，且不显示鼠标位置信息。
- 修改点
  1. 引入 `pynput.mouse` 库，新增 `_on_mouse_press` 监听方法，记录鼠标按键类型（左键 / 右键 / 中间键）与状态（按下 / 松开）。
  2. 日志格式优化：鼠标事件日志改为 `Mouse: 左键按下`/`Mouse: 右键松开` 样式，删除位置信息（原 `(位置: x=xxx, y=xxx)` 字段）。
  3. 类名从 `BackgroundKeyboardLogger` 改为 `InputLogger`，适配 “键盘 + 鼠标” 双记录功能定位。

#### 2.3 命令行参数支持（运行模式扩展）

- **需求 1**：添加 `-m` 参数，控制是否显示弹窗（`-m` 模式下不显示启动 / 退出弹窗）。
  - 修改点：在 `__init__` 方法中新增 `show_popups` 参数，通过 `sys.argv` 检测 `-m` 参数，控制 `_show_start_popup` 和 `_show_exit_popup` 方法的执行逻辑。
- **需求 2**：添加 `-q` 参数，控制是否退出控制台窗口（`-q` 模式下启动后自动关闭窗口，进程后台运行）。
  - 修改点：新增 `quit_window` 参数，新增 `_exit_console_window` 方法（通过 `win32gui.PostMessage` 发送窗口关闭消息），在 `start_logging` 中根据 `quit_window` 状态决定是否执行窗口关闭。

#### 2.4 帮助信息功能新增

- **需求**：添加 `-h`/`-help`/`-?` 参数，显示脚本使用帮助。
- 修改点
  1. 新增 `show_help` 函数，输出包含 “功能简介、使用方式、参数说明、退出方式” 的帮助文本。
  2. 在 `__main__` 中优先检测帮助参数，若存在则执行 `show_help` 并退出，不启动记录功能。

#### 2.5 进程稳定性优化

- **问题**：初始版本存在 “窗口隐藏后主线程退出导致进程终止” 的问题。
- **修改点**：在 `start_logging` 方法中添加循环等待逻辑（`while self.keyboard_listener.running and self.mouse_listener.running: time.sleep(0.1)`），确保主线程持续运行，直至监听线程停止。

### 3. 最终版本功能清单

| 功能模块 | 具体能力                                                     |
| -------- | ------------------------------------------------------------ |
| 键盘记录 | 记录普通键、特殊键、组合键，解决 Ctrl 组合键乱码，日志格式为 `Key pressed: ctrl+c` |
| 鼠标记录 | 记录左键 / 右键 / 中间键的按下 / 松开，日志格式为 `Mouse: 左键按下` |
| 日志配置 | 日志文件 `keyboard_log.txt`，UTF-8 编码，自动覆盖旧日志，含时间戳 |
| 弹窗交互 | 默认显示启动 / 退出弹窗，`-m` 参数可关闭                     |
| 窗口控制 | 默认显示控制台窗口，`-q` 参数可启动后自动关闭窗口（进程后台运行） |
| 帮助信息 | `-h`/`-help`/`-?` 参数显示使用说明                           |
| 退出方式 | 按下 `Ctrl+Shift+F12` 组合键，停止记录并退出程序             |

## 三、使用方式（基于最终版本）

### 3.1 基础命令

| 命令                  | 功能说明                                                    |
| --------------------- | ----------------------------------------------------------- |
| `python app.py -h`    | 显示帮助信息                                                |
| `python app.py`       | 正常运行：显示控制台窗口，显示启动 / 退出弹窗，记录键鼠操作 |
| `python app.py -q`    | 后台运行：启动后关闭控制台窗口，显示弹窗，记录操作          |
| `python app.py -m`    | 显示窗口：不显示弹窗，记录操作                              |
| `python app.py -q -m` | 完全后台：关闭窗口 + 不显示弹窗，静默记录操作               |

### 3.2 退出方式

- 按下 `Ctrl+Shift+F12` 组合键，程序停止记录，生成退出日志，并根据 `-m` 参数决定是否显示 “键盘记录器已结束” 弹窗。

## 四、依赖库说明

脚本运行需安装以下依赖（Python 3.x 环境）：

```bash
# 核心依赖：键盘/鼠标监听
pip install pynput
# 窗口控制依赖（Windows 系统）
pip install pywin32
# tkinter 为 Python 内置库，无需额外安装（若缺失，需根据系统补装，如 Ubuntu 安装 python3-tk）
```

## 五、日志示例（最终版本）

```plaintext
2025-09-01 23:27:30 - Mouse: 左键按下
2025-09-01 23:27:30 - Mouse: 左键松开
2025-09-01 23:27:31 - Key pressed: a
2025-09-01 23:27:32 - Key pressed: ctrl+s
2025-09-01 23:27:35 - Mouse: 右键按下
2025-09-01 23:27:35 - Mouse: 右键松开
2025-09-01 23:27:40 - 程序已停止 (Ctrl+Shift+F12组合键被按下)
```
